<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Inventario e Prenotazioni</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  
  <div *ngIf="isLoading" class="ion-text-center ion-padding-top">
    <ion-spinner name="crescent"></ion-spinner>
  </div>

  <div class="center-wrapper" *ngIf="!isLoading">
    <div class="container-list">

      <ion-item *ngIf="libraryBooks.length === 0" lines="none">
        <ion-label class="ion-text-center">
          Nessun libro trovato nell'inventario.
        </ion-label>
      </ion-item>

      <!-- Ciclo sui libri -->
      <div *ngFor="let book of libraryBooks" class="book-item-wrapper">
        
        <!-- Card principale del libro -->
        <ion-item lines="full">

          <ion-thumbnail slot="start">
            <img [src]="book.cover_url || 'assets/images/placeholder.png'" />
          </ion-thumbnail>

          <ion-label class="text">
            <h2>{{ book.title }}</h2>
            <p>{{ book.author }}</p>
          </ion-label>

          <div class="inventory-controls" slot="end">
            <div class="copy-counter">
              <h3>
                <span>Copie Totali:</span> {{ book.total_copies }} 
                <span> | </span>
                <span [class.copies-zero]="book.available_copies === 0">Copie Disponibili: {{ book.available_copies }}</span> 
              </h3>
            </div>
            <!-- Bottone per espandere/collassare prenotazioni -->
            <ion-button 
              color="medium"
              fill="clear" 
              size="small"
              (click)="toggleReservations(book.id)">
              <ion-icon
                [name]="isExpanded(book.id) ? 'chevron-up' : 'chevron-down'"
                slot="icon-only"
              ></ion-icon>
            </ion-button>
          </div>
        </ion-item>

        <!-- Dettagli prenotazioni espandibili -->
        <ion-item *ngIf="isExpanded(book.id)" class="reservations-details" lines="none">
          <ion-grid>
            <!-- Header prenotazioni -->
            <ion-row *ngIf="reservation[book.id] && reservation[book.id].length > 0">
              <ion-col size="12" class="reservations-header">
                <strong>Prenotazioni ({{ reservation[book.id].length }})</strong>
              </ion-col>
            </ion-row>
            <!-- Lista prenotazioni -->
            <ion-row *ngFor="let prenot of reservation[book.id]" class="reservation-row">
              <ion-col size="12">
                <p class="reservation-info">
                  <strong>Utente:</strong> {{ prenot.username }} | 
                  <strong>Data:</strong> {{ prenot.reservation_date | date: 'dd/MM/yyyy' }}
                </p>
              </ion-col>
            </ion-row>
            <!-- Messaggio nessuna prenotazione -->
            <ion-row *ngIf="reservation[book.id] && reservation[book.id].length === 0">
              <ion-col size="12">
                <p class="no-reservations"><em>Nessuna prenotazione per questo libro</em></p>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-item>

        <!-- Bottone richiedi copie (sempre visibile) -->
        <ion-item *ngIf="isExpanded(book.id)" lines="full" class="request-copies-item">
          <ion-button 
            color="success"
            fill="outline" 
            size="small"
            expand="block"
            (click)="requestCopies(book)">
            Richiedi Copie
          </ion-button>
        </ion-item>

      </div>
    </div>
  </div>
</ion-content>
